<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Doctor Listing Page</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Arial', sans-serif;
      background-color: #f1f3f6;
    }

    header {
      background-color: #245bb3;
      padding: 10px 20px;
      display: flex;
      align-items: center;
    }

    header input {
      width: 100%;
      max-width: 600px;
      padding: 10px;
      border-radius: 4px;
      border: none;
      outline: none;
      font-size: 16px;
    }

    .container {
      display: flex;
      padding: 20px;
      gap: 20px;
    }

    .sidebar {
      width: 300px;
      background: white;
      padding: 20px;
      border-radius: 8px;
    }

    .sidebar section {
      margin-bottom: 20px;
    }

    .sidebar h4 {
      margin: 10px 0;
      font-size: 14px;
      color: #444;
    }

    .sidebar label {
      display: block;
      font-size: 14px;
      margin-bottom: 8px;
      cursor: pointer;
    }

    .content {
      flex: 1;
    }

    .doctor-card {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #ddd;
    }

    .doctor-info {
      flex: 1;
    }

    .doctor-name {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .doctor-meta {
      font-size: 14px;
      color: #555;
      margin-bottom: 4px;
    }

    .doctor-fee {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .book-btn {
      background: white;
      color: #245bb3;
      border: 1px solid #245bb3;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    .suggestions {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      max-width: 600px;
      width: calc(100% - 40px);
      margin-left: 20px;
      z-index: 10;
    }

    .suggestion-item {
      padding: 10px;
      cursor: pointer;
    }

    .suggestion-item:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>

  <header>
    <input type="text" id="searchInput" placeholder="Search Symptoms, Doctors, Specialists, Clinics" data-testid="autocomplete-input" autocomplete="off" />
  </header>

  <div id="suggestions" class="suggestions"></div>

  <div class="container">
    <div class="sidebar">
      <section>
        <h4>Sort by</h4>
        <label><input type="radio" name="sort" value="fees" data-testid="sort-fees">Price: Low–High</label>
        <label><input type="radio" name="sort" value="experience" data-testid="sort-experience">Experience – Most Experience first</label>
      </section>

      <section>
        <h4>Specialities</h4>
        <div id="specialty-filters"></div>
      </section>

      <section>
        <h4>Mode of consultation</h4>
        <label><input type="radio" name="mode" value="video" data-testid="filter-video-consult">Video Consultation</label>
        <label><input type="radio" name="mode" value="clinic" data-testid="filter-in-clinic">In-clinic Consultation</label>

      </section>
    </div>

    <div class="content">
      <div id="doctorList"></div>
    </div>
  </div>

  <script>
    const apiURL = "https://srijandubey.github.io/campus-api-mock/SRM-C1-25.json";
    let doctors = [];
    const searchInput = document.getElementById("searchInput");
    const suggestionsBox = document.getElementById("suggestions");
    const specialtyFilters = document.getElementById("specialty-filters");
    const doctorList = document.getElementById("doctorList");

    const specialtyList = [
      "General Physician","Dentist","Dermatologist","Paediatrician","Gynaecologist","ENT","Diabetologist",
      "Cardiologist","Physiotherapist","Endocrinologist","Orthopaedic","Ophthalmologist","Gastroenterologist",
      "Pulmonologist","Psychiatrist","Urologist","Dietitian/Nutritionist","Psychologist","Sexologist",
      "Nephrologist","Neurologist","Oncologist","Ayurveda","Homeopath"
    ];

    function renderSpecialties() {
      specialtyList.forEach(s => {
        const id = `filter-specialty-${s.replaceAll(" ", "-").replace("/", "-")}`;
        specialtyFilters.innerHTML += `
          <label><input type="checkbox" value="${s}" data-testid="${id}"/>${s}</label>
        `;
      });
    }

    function getFiltersFromURL() {
      const params = new URLSearchParams(window.location.search);
      return {
        search: params.get("search") || "",
        mode: params.get("mode") || "",
        specialties: params.get("specialties") ? params.get("specialties").split(",") : [],
        sort: params.get("sort") || ""
      };
    }

    function updateURL(filters) {
      const params = new URLSearchParams();
      if (filters.search) params.set("search", filters.search);
      if (filters.mode) params.set("mode", filters.mode);
      if (filters.specialties.length) params.set("specialties", filters.specialties.join(","));
      if (filters.sort) params.set("sort", filters.sort);
      history.pushState(null, "", "?" + params.toString());
    }

    function applyFilters() {
        let { search, mode, specialties, sort } = getFiltersFromURL();
        let filtered = [...doctors];
      
        // Search filter
        if (search) {
          filtered = filtered.filter(doc =>
            doc.name.toLowerCase().includes(search.toLowerCase())
          );
        }
      
        // Mode filter (video or in-clinic)
        if (mode) {
          filtered = filtered.filter(doc => {
            if (mode === 'video') return doc.video_consult === true;
            if (mode === 'clinic') return doc.in_clinic === true;
            return true;
          });
        }
      
        // Specialty filter - now uses some() for matching any selected specialty
        if (specialties.length) {
          filtered = filtered.filter(doc =>
            specialties.some(s =>
              doc.specialties.some(sp =>
                sp.name.toLowerCase().includes(s.toLowerCase())
              )
            )
          );
        }
      
        // Sort filter (fees or experience)
        if (sort === "fees") {
          filtered.sort((a, b) =>
            parseInt(a.fees.replace('₹', '').replace(',', '').trim()) -
            parseInt(b.fees.replace('₹', '').replace(',', '').trim())
          );
        } else if (sort === "experience") {
          filtered.sort((a, b) =>
            parseInt(b.experience.split(" ")[0]) -
            parseInt(a.experience.split(" ")[0])
          );
        }
      
        renderDoctors(filtered);
      }  
      

    function renderDoctors(data) {
      doctorList.innerHTML = "";
      data.forEach(doc => {
        const card = document.createElement("div");
        card.className = "doctor-card";
        card.setAttribute("data-testid", "doctor-card");
        card.innerHTML = `
          <div class="doctor-info">
            <div class="doctor-name" data-testid="doctor-name">${doc.name}</div>
            <div class="doctor-meta" data-testid="doctor-specialty">${doc.specialties.join(", ")}</div>
            <div class="doctor-meta" data-testid="doctor-experience">${doc.experience} yrs exp.</div>
          </div>
          <div style="text-align: right;">
            <div class="doctor-fee" data-testid="doctor-fee">${doc.fees}</div>
            <button class="book-btn">Book Appointment</button>
          </div>
        `;
        doctorList.appendChild(card);
      });
    }

    function initListeners() {
      searchInput.addEventListener("input", () => {
        const val = searchInput.value.toLowerCase();
        if (!val) {
          suggestionsBox.innerHTML = "";
          return;
        }
        const matches = doctors
          .filter(doc => doc.name.toLowerCase().includes(val))
          .slice(0, 3);

        suggestionsBox.innerHTML = matches.map(m => `<div class="suggestion-item" data-testid="suggestion-item">${m.name}</div>`).join("");
      });

      suggestionsBox.addEventListener("click", (e) => {
        if (e.target.classList.contains("suggestion-item")) {
          searchInput.value = e.target.textContent;
          updateFiltersAndApply({ search: e.target.textContent });
          suggestionsBox.innerHTML = "";
        }
      });

      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          updateFiltersAndApply({ search: searchInput.value });
          suggestionsBox.innerHTML = "";
        }
      });

      document.querySelectorAll("[name='mode']").forEach(radio => {
        radio.addEventListener("change", () => updateFiltersAndApply({ mode: radio.value }));
      });

      document.querySelectorAll("#specialty-filters input[type='checkbox']").forEach(checkbox => {
        checkbox.addEventListener("change", () => {
          const checked = [...document.querySelectorAll("#specialty-filters input[type='checkbox']:checked")].map(cb => cb.value);
          updateFiltersAndApply({ specialties: checked });
        });
      });

      document.querySelectorAll("[name='sort']").forEach(radio => {
        radio.addEventListener("change", () => updateFiltersAndApply({ sort: radio.value }));
      });

      window.addEventListener("popstate", () => {
        syncFormWithURL();
        applyFilters();
      });
    }

    function updateFiltersAndApply(update) {
      const filters = getFiltersFromURL();
      const newFilters = { ...filters, ...update };
      updateURL(newFilters);
      syncFormWithURL();
      applyFilters();
    }

    function syncFormWithURL() {
      const filters = getFiltersFromURL();
      searchInput.value = filters.search;

      if (filters.mode) {
        const radio = document.querySelector(`[name="mode"][value="${filters.mode}"]`);
        if (radio) radio.checked = true;
      }

      document.querySelectorAll("#specialty-filters input[type='checkbox']").forEach(cb => {
        cb.checked = filters.specialties.includes(cb.value);
      });

      if (filters.sort) {
        const radio = document.querySelector(`[name="sort"][value="${filters.sort}"]`);
        if (radio) radio.checked = true;
      }
    }

    async function init() {
        const res = await fetch(apiURL);
        doctors = await res.json();
        
      

      // Normalize specialties
      doctors = doctors.map(doc => ({
        ...doc,
        specialties: Array.isArray(doc.specialties)
          ? doc.specialties
          : [doc.specialties]
      }));

      renderSpecialties();
      syncFormWithURL();
      initListeners();
      applyFilters();
    }

    init();
  </script>
</body>
</html>
